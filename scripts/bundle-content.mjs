/**
 * Prebuild script: reads all markdown content files and generates
 * src/lib/content-data.ts with the combined rules content as a string constant.
 *
 * This avoids fs.readFileSync at runtime, which fails on Cloudflare Workers.
 */
import fs from "node:fs";
import path from "node:path";
import { fileURLToPath } from "node:url";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const projectRoot = path.join(__dirname, "..");
const contentDir = path.join(projectRoot, "content");

const DOC_MAP = [
  { slug: "core-rules", title: "Core Rules", file: "azeroth-at-war-v1.1.md", category: "Core Rules" },
  { slug: "refinement-notes", title: "Refinement Notes", file: "azeroth-at-war-refinement-notes.md", category: "Core Rules" },
  { slug: "faction-overview", title: "Faction Overview", file: "faction-overview.md", category: "Factions" },
  { slug: "army-book-humans", title: "Army Book: Humans", file: "army-book-humans.md", category: "Army Books — Alliance" },
  { slug: "army-book-dwarves", title: "Army Book: Dwarves", file: "army-book-dwarves.md", category: "Army Books — Alliance" },
  { slug: "army-book-night-elves", title: "Army Book: Night Elves", file: "army-book-night-elves.md", category: "Army Books — Alliance" },
  { slug: "army-book-orcs", title: "Army Book: Orcs", file: "army-book-orcs.md", category: "Army Books — Horde" },
  { slug: "army-book-forsaken", title: "Army Book: Forsaken", file: "army-book-forsaken.md", category: "Army Books — Horde" },
  { slug: "army-book-darkspear", title: "Army Book: Darkspear Trolls", file: "army-book-darkspear.md", category: "Army Books — Horde" },
  { slug: "army-book-scourge", title: "Army Book: Scourge", file: "army-book-scourge.md", category: "Army Books — Scourge" },
  { slug: "unit-customization", title: "Unit Customization System", file: "unit-customization-system.md", category: "Systems" },
  { slug: "fly-keyword", title: "Fly Keyword Draft", file: "fly-keyword-draft.md", category: "Systems" },
];

// Build per-doc map for individual lookups
const docs = DOC_MAP.map((doc) => {
  const filePath = path.join(contentDir, doc.file);
  const content = fs.readFileSync(filePath, "utf-8");
  return { slug: doc.slug, title: doc.title, category: doc.category, content };
});

// Also build combined content for the ask/AI page
const allContent = docs
  .map((d) => `--- ${d.title} ---\n\n${d.content}`)
  .join("\n\n");

const output = `// Auto-generated by scripts/bundle-content.mjs — do not edit
export const allRulesContent = ${JSON.stringify(allContent)};

export interface BundledDoc {
  slug: string;
  title: string;
  category: string;
  content: string;
}

export const bundledDocs: BundledDoc[] = ${JSON.stringify(docs, null, 2)};
`;

const outPath = path.join(projectRoot, "src", "lib", "content-data.ts");
fs.writeFileSync(outPath, output, "utf-8");
console.log(`Bundled ${DOC_MAP.length} docs → ${outPath}`);
